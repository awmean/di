{% extends "base.html" %}

{% block title %}Оформление заявки{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Back Navigation -->
        <div class="mb-8">
            <a href="/" class="text-gray-600 hover:text-gray-800 flex items-center space-x-2">
                <span>← ВЕРНУТЬСЯ НАЗАД</span>
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            <!-- Order Form -->
            <div class="bg-white rounded-lg shadow-sm p-6 lg:p-8">
                <h1 class="text-2xl font-light text-gray-900 mb-8">Оформление заявки</h1>

                <form id="orderForm" class="space-y-6">
                    <!-- Name Field -->
                    <div>
                        <input type="text"
                               id="customerName"
                               name="customer_name"
                               placeholder="Имя"
                               required
                               class="w-full px-4 py-4 border border-gray-300 rounded-none bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:border-gray-500 transition-colors">
                    </div>

                    <!-- Phone Field -->
                    <div class="relative">
                        <div class="absolute left-0 top-0 h-full flex items-center px-4 bg-gray-50 border-r border-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 9 6" width="24" height="16">
                                <path d="m0 0h9v2H0" fill="#fff"/>
                                <path d="m0 2h9v2H0" fill="#0039a6"/>
                                <path d="m0 4h9v2H0" fill="#d52b1e"/>
                            </svg>
                            <span class="ml-2 text-gray-700">+7</span>
                        </div>

                        <input type="tel"
                               id="customerPhone"
                               name="customer_phone"
                               placeholder="(000) 000-00-00"
                               required
                               class="w-full pl-24 pr-4 py-4 border border-gray-300 rounded-none bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:border-gray-500 transition-colors">
                    </div>

                    <!-- Comment Field -->
                    <div>
                        <textarea id="comment"
                                  name="comment"
                                  placeholder="Комментарий к заказу (необязательно)"
                                  rows="4"
                                  class="w-full px-4 py-4 border border-gray-300 rounded-none bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:border-gray-500 transition-colors resize-vertical"></textarea>
                    </div>

                    <!-- Privacy Policy Checkbox -->
                    <div class="flex items-start space-x-3">
                        <input type="checkbox"
                               id="privacyConsent"
                               name="privacy_consent"
                               required
                               class="mt-1 w-4 h-4 text-black bg-white border-gray-300 rounded focus:ring-black focus:ring-2">
                        <label for="privacyConsent" class="text-sm text-gray-600 leading-relaxed">
                            Я соглашаюсь на <a href="/privacy" class="underline hover:no-underline">обработку персональных данных</a>
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit"
                            class="w-full bg-black text-white py-4 px-8 font-medium tracking-wider hover:bg-gray-800 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="submitBtnText">Консультация с менеджером</span>
                        <span id="submitLoader" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Отправка...
                        </span>
                    </button>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-lg shadow-sm p-6 lg:p-8">
                <h2 class="text-xl font-light text-gray-900 mb-6">Ваш заказ</h2>

                <div id="cartItems" class="space-y-6">
                    <!-- Cart items will be inserted here by JavaScript -->
                </div>

                <div id="emptyCart" class="hidden text-center py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2L3 7v11a2 2 0 002 2h10a2 2 0 002-2V7l-7-5zM8 15a1 1 0 100-2 1 1 0 000 2zm4-2a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"></path>
                    </svg>
                    <p class="text-gray-500 mb-4">Ваша корзина пуста</p>
                    <a href="/catalog" class="text-black underline hover:no-underline">Перейти к каталогу</a>
                </div>

                <div id="orderTotal" class="border-t border-gray-200 pt-6 mt-6">
                    <div class="flex justify-between items-center text-xl font-light">
                        <span>Сумма:</span>
                        <span id="totalAmount">0 р.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal - адаптированная для мобильных -->
<div id="successModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full mx-4 p-6 sm:p-8 text-center">
        <div class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <h3 class="text-xl font-medium text-gray-900 mb-2">Заявка отправлена!</h3>
        <p class="text-gray-600 mb-6 text-sm sm:text-base">Мы свяжемся с вами в ближайшее время для консультации по выбранным товарам.</p>
        <button onclick="closeSuccessModal()" class="w-full bg-black text-white py-3 px-6 font-medium hover:bg-gray-800 transition-colors text-sm sm:text-base">
            Понятно
        </button>
    </div>
</div>

<!-- Шаблон для товара в корзине -->
<template id="cartItemTemplate">
    <div class="flex items-start space-x-3 sm:space-x-4 pb-6 border-b border-gray-100 last:border-b-0">
        <div class="flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-lg overflow-hidden">
            <img class="cart-item-image w-full h-full object-cover hidden" alt="">
            <div class="cart-item-placeholder w-full h-full flex items-center justify-center text-gray-300">
                <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
        <div class="flex-1 min-w-0">
            <h3 class="font-medium text-gray-900 mb-1 text-sm sm:text-base cart-item-name"></h3>
            <p class="text-xs sm:text-sm text-gray-600 mb-2 cart-item-description hidden"></p>
        </div>
        <div class="flex flex-col sm:flex-row items-end sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
            <div class="flex items-center space-x-2 sm:space-x-3">
                <button class="decrease-btn w-8 h-8 sm:w-9 sm:h-9 rounded-full border border-gray-300 flex items-center justify-center text-gray-600 hover:bg-gray-50 active:bg-gray-100 transition-colors">
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                </button>
                <span class="text-gray-900 font-medium w-8 text-center text-sm sm:text-base cart-item-quantity"></span>
                <button class="increase-btn w-8 h-8 sm:w-9 sm:h-9 rounded-full border border-gray-300 flex items-center justify-center text-gray-600 hover:bg-gray-50 active:bg-gray-100 transition-colors">
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </button>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-3">
                <div class="text-right min-w-0">
                    <p class="text-base sm:text-lg font-medium text-gray-900 cart-item-total"></p>
                </div>
                <button class="remove-btn text-gray-400 hover:text-red-500 transition-colors p-1">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</template>

<script src="/static/js/cart-localstorage.min.js"></script>
<script>

function formatPhoneNumber(value) {
    const digits = value.replace(/\D/g, '');

    if (digits.length >= 10) {
        return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 8)}-${digits.slice(8, 10)}`;
    } else if (digits.length >= 6) {
        return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
    } else if (digits.length >= 3) {
        return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
    }
    return digits;
}


function createCartItemElement(item) {
    const template = document.getElementById('cartItemTemplate');
    const element = template.content.cloneNode(true);

    const itemTotal = (item.price || 0) * (item.quantity || 1);


    const image = element.querySelector('.cart-item-image');
    const placeholder = element.querySelector('.cart-item-placeholder');
    const name = element.querySelector('.cart-item-name');
    const description = element.querySelector('.cart-item-description');
    const quantity = element.querySelector('.cart-item-quantity');
    const total = element.querySelector('.cart-item-total');

    if (item.image) {
        image.src = item.image;
        image.alt = item.name;
        image.classList.remove('hidden');
        placeholder.classList.add('hidden');
    }

    name.textContent = item.name;

    if (item.description) {
        description.textContent = item.description;
        description.classList.remove('hidden');
    }

    quantity.textContent = item.quantity;
    total.textContent = `${Math.round(itemTotal).toLocaleString()} р.`;


    const decreaseBtn = element.querySelector('.decrease-btn');
    const increaseBtn = element.querySelector('.increase-btn');
    const removeBtn = element.querySelector('.remove-btn');

    decreaseBtn.addEventListener('click', () => decreaseQuantity(item.id));
    increaseBtn.addEventListener('click', () => increaseQuantity(item.id));
    removeBtn.addEventListener('click', () => removeFromCart(item.id));

    return element;
}


document.addEventListener('DOMContentLoaded', function() {
    loadCartItems();
    setupEventListeners();
});

function setupEventListeners() {

    const phoneInput = document.getElementById('customerPhone');
    phoneInput.addEventListener('input', function(e) {
        const formatted = formatPhoneNumber(e.target.value);
        e.target.value = formatted;
    });


    document.getElementById('orderForm').addEventListener('submit', handleFormSubmit);
}

function loadCartItems() {
    const cartItems = cartLS.list();
    const cartContainer = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const orderTotal = document.getElementById('orderTotal');
    const totalAmount = document.getElementById('totalAmount');

    if (cartItems.length === 0) {
        cartContainer.innerHTML = '';
        emptyCart.classList.remove('hidden');
        orderTotal.classList.add('hidden');
        return;
    }

    emptyCart.classList.add('hidden');
    orderTotal.classList.remove('hidden');


    cartContainer.innerHTML = '';

    let total = 0;

    cartItems.forEach(item => {
        const itemTotal = (item.price || 0) * (item.quantity || 1);
        total += itemTotal;

        const element = createCartItemElement(item);
        cartContainer.appendChild(element);
    });

    totalAmount.textContent = `${Math.round(total).toLocaleString()} р.`;
}

function increaseQuantity(productId) {
    cartLS.quantity(productId, 1);
    loadCartItems();
}

function decreaseQuantity(productId) {
    cartLS.quantity(productId, -1);
    loadCartItems();
}

function removeFromCart(productId) {
    cartLS.remove(productId);
    loadCartItems();
}

async function handleFormSubmit(e) {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const btnText = document.getElementById('submitBtnText');
    const loader = document.getElementById('submitLoader');


    submitBtn.disabled = true;
    btnText.classList.add('hidden');
    loader.classList.remove('hidden');

    try {
        const formData = new FormData(e.target);
        const cartItems = cartLS.list();

        if (cartItems.length === 0) {
            alert('Ваша корзина пуста');
            return;
        }


        const orderData = {
            customer_name: formData.get('customer_name'),
            customer_phone: '+7' + formData.get('customer_phone').replace(/\D/g, ''),
            comment: formData.get('comment') || '',
            status: 'new',
            items: cartItems.map(item => ({
                product_id: item.id,
                quantity: item.quantity || 1,
                price: item.price || 0
            }))
        };


        const response = await fetch('/order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });

        if (response.ok) {

            cartLS.destroy();
            showSuccessModal();
        } else {
            throw new Error('Ошибка при отправке заявки');
        }

    } catch (error) {
        console.error('Error submitting order:', error);
        alert('Произошла ошибка при отправке заявки. Пожалуйста, попробуйте еще раз.');
    } finally {

        submitBtn.disabled = false;
        btnText.classList.remove('hidden');
        loader.classList.add('hidden');
    }
}

function showSuccessModal() {
    document.getElementById('successModal').classList.remove('hidden');

    document.body.style.overflow = 'hidden';
}

function closeSuccessModal() {
    document.getElementById('successModal').classList.add('hidden');
    document.body.style.overflow = '';

    setTimeout(() => {
        window.location.href = '/';
    }, 500);
}


document.getElementById('successModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSuccessModal();
    }
});


document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('successModal');
        if (!modal.classList.contains('hidden')) {
            closeSuccessModal();
        }
    }
});
</script>
{% endblock %}