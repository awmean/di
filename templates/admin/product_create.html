{% extends 'base.html' %}

{% block title %}Create Product - Admin{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>
<!-- FilePond CSS -->
<link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet">
<link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css" rel="stylesheet">
<!-- FilePond JS -->
<script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.min.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.min.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.js"></script>
<style>
    .media-preview img {
        max-width: 150px;
        max-height: 150px;
        object-fit: cover;
    }

    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-8 flex items-center justify-between">
    <div>
        <h2 class="text-2xl font-bold text-gray-900">Создать новый товар</h2>
        <p class="mt-1 text-sm text-gray-500">Добавить новый товар в каталог</p>
    </div>
    <a href="/admin/products"
       class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
        Назад к товарам
    </a>
</div>

<!-- Success message area (initially hidden) -->
<div id="success-message" class="mb-4 hidden">
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
        <strong>Успешно!</strong> Товар создан. Теперь вы можете загрузить медиафайлы.
    </div>
</div>

<!-- Error message area -->
<div id="error-message" class="mb-4"></div>

<!-- Main form -->
<div id="main-form">
    <form id="product-form"
          hx-post="/api/products/"
          hx-headers='{"Content-Type": "application/json"}'
          hx-target="#error-message"
          hx-swap="innerHTML"
          hx-ext="json-enc"
          class="space-y-8">

        <!-- Основная информация -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Основная информация</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Название товара *</label>
                    <input type="text"
                           id="name"
                           name="name"
                           required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="slug" class="block text-sm font-medium text-gray-700">URL-адрес *</label>
                    <input type="text"
                           id="slug"
                           name="slug"
                           required
                           placeholder=""
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="mt-6">
                <label for="short_description" class="block text-sm font-medium text-gray-700">Краткое описание</label>
                <input type="text"
                       id="short_description"
                       name="short_description"
                       maxlength="500"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="mt-6">
                <label for="description" class="block text-sm font-medium text-gray-700">Полное описание</label>
                <textarea id="description"
                          name="description"
                          rows="4"
                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
        </div>

        <!-- Категория и иерархия -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Категория и иерархия</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="category_id" class="block text-sm font-medium text-gray-700">Категория *</label>
                    <select id="category_id"
                            name="category_id"
                            required
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Выберите категорию</option>
                        {% for category in categories %}
                        {% if category.is_active %}
                        <option value="{{ category.id }}">
                            {% if category.parent %}{{ category.parent.name }} → {% endif %}{{ category.name }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="parent_id" class="block text-sm font-medium text-gray-700">Родительский товар</label>
                    <select id="parent_id"
                            name="parent_id"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Нет (Отдельный/Набор)</option>
                        {% for product in products %}
                        {% if product.is_active and (product.is_set or product.is_standalone_product) %}
                        <option value="{{ product.id }}">
                            {{ product.name }}
                            {% if product.is_set %}
                            (Набор - {{ product.set_piece_count or product.children|length }} шт.)
                            {% endif %}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Выберите родительский товар, если это отдельная часть
                        набора</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div>
                    <label for="set_piece_count" class="block text-sm font-medium text-gray-700">Количество частей в
                        наборе</label>
                    <input type="number"
                           id="set_piece_count"
                           name="set_piece_count"
                           min="1"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Общее количество частей, если это набор</p>
                </div>

                <div>
                    <label for="piece_quantity" class="block text-sm font-medium text-gray-700">Количество
                        частей</label>
                    <input type="number"
                           id="piece_quantity"
                           name="piece_quantity"
                           min="1"
                           value="1"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Сколько таких частей в наборе</p>
                </div>
            </div>
        </div>

        <!-- Цены -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Цены и артикул</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700">Цена</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">₽</span>
                        </div>
                        <input type="number"
                               id="price"
                               name="price"
                               step="0.01"
                               min="0"
                               class="pl-7 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label for="old_price" class="block text-sm font-medium text-gray-700">Старая цена</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">₽</span>
                        </div>
                        <input type="number"
                               id="old_price"
                               name="old_price"
                               step="0.01"
                               min="0"
                               class="pl-7 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label for="sku" class="block text-sm font-medium text-gray-700">Артикул</label>
                    <input type="text"
                           id="sku"
                           name="sku"
                           maxlength="50"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- SEO -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">SEO</h3>

            <div class="space-y-6">
                <div>
                    <label for="meta_title" class="block text-sm font-medium text-gray-700">Мета-заголовок</label>
                    <input type="text"
                           id="meta_title"
                           name="meta_title"
                           maxlength="200"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Оставьте пустым для автоматической генерации из названия
                        товара</p>
                </div>

                <div>
                    <label for="meta_description" class="block text-sm font-medium text-gray-700">Мета-описание</label>
                    <textarea id="meta_description"
                              name="meta_description"
                              maxlength="300"
                              rows="3"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>
        </div>

        <!-- Действия формы -->
        <div class="flex justify-end space-x-4">
            <a href="/admin/products"
               class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md text-sm font-medium">
                Отмена
            </a>
            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium">
                Создать товар
            </button>
        </div>
    </form>
</div>

<!-- Media upload section (initially hidden) -->
<div id="media-upload-section" class="hidden space-y-8">
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-6">Загрузить медиафайлы</h3>
        <p class="text-sm text-gray-500 mb-4">Загрузите фотографии и видео для товара (максимум 100 МБ на файл)</p>

        <!-- FilePond input -->
        <input type="file"
               class="filepond"
               name="file"
               multiple
               data-allow-reorder="true"
               data-max-file-size="100MB"
               data-max-files="20">
    </div>

    <div class="flex justify-end space-x-4">
        <a href="/admin/products"
           class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md text-sm font-medium">
            Завершить и перейти к товарам
        </a>
    </div>
</div>

<script>
    // Register FilePond plugins
    FilePond.registerPlugin(
        FilePondPluginImagePreview,
        FilePondPluginFileValidateSize,
        FilePondPluginFileValidateType
    );

    let createdProductId = null;

    // Handle successful product creation
    document.addEventListener('htmx:afterRequest', function (event) {
        if (event.detail.requestConfig.verb === 'post' &&
            event.detail.requestConfig.path === '/api/products/' &&
            event.detail.xhr.status >= 200 && event.detail.xhr.status < 300) {

            // Parse the response to get product ID
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                createdProductId = response.id;

                // Hide the main form and show success message
                document.getElementById('main-form').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                document.getElementById('media-upload-section').classList.remove('hidden');

                // Clear any error messages
                document.getElementById('error-message').innerHTML = '';

                // Initialize FilePond
                initializeFilePond();
            } catch (e) {
                console.error('Error parsing response:', e);
            }
        }
    });

    function initializeFilePond() {
        // Create FilePond instance
        FilePond.create(
            document.querySelector('.filepond'), {
                server: {
                    process: {
                        url: '/api/media/upload',
                        ondata: (formData) => {
                            formData.append('product_id', createdProductId);
                            formData.append('alt_text', '');
                            return formData;
                        }
                    }
                }
            }
        );
    }
</script>

{% endblock %}