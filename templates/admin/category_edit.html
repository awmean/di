{% extends 'base.html' %}

{% block title %}Редактировать категорию - {{ category.name }} - Админ{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<style>
    .file-drop-zone {
        border: 2px dashed #d1d5db;
        transition: all 0.3s ease;
    }
    .file-drop-zone.drag-over {
        border-color: #3b82f6;
        background-color: #eff6ff;
    }
    .media-preview img {
        max-width: 150px;
        max-height: 150px;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-8 flex items-center justify-between">
    <div>
        <h2 class="text-2xl font-bold text-gray-900">Редактировать категорию</h2>
        <p class="mt-1 text-sm text-gray-500">Изменить категорию: {{ category.name }}</p>
    </div>
    <div class="flex space-x-3">
        <a href="/admin/categories"
           class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            Назад к категориям
        </a>
    </div>
</div>

<!-- Область ответа формы -->
<div id="form-response" class="mb-4"></div>

<form id="category-edit-form" class="space-y-8">
    <!-- Основная информация -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-6">Основная информация</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Название категории *</label>
                <input type="text"
                       id="name"
                       name="name"
                       required
                       value="{{ category.name }}"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label for="slug" class="block text-sm font-medium text-gray-700">Слаг *</label>
                <input type="text"
                       id="slug"
                       name="slug"
                       required
                       value="{{ category.slug }}"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="mt-6">
            <label for="description" class="block text-sm font-medium text-gray-700">Описание</label>
            <textarea id="description"
                      name="description"
                      rows="4"
                      placeholder="Краткое описание этой категории и какие товары она содержит..."
                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">{{ category.description or '' }}</textarea>
        </div>
    </div>

    <!-- Иерархия и организация -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-6">Иерархия и организация</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="parent_id" class="block text-sm font-medium text-gray-700">Родительская категория</label>
                <select id="parent_id"
                        name="parent_id"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Нет (Корневая категория)</option>
                    {% for potential_parent in categories %}
                        {% if potential_parent.is_active and potential_parent.id != category.id %}
                        <option value="{{ potential_parent.id }}" {% if potential_parent.id == category.parent_id %}selected{% endif %}>
                            {% if potential_parent.parent %}{{ potential_parent.parent.name }} → {% endif %}{{ potential_parent.name }}
                            {% if potential_parent.children|length > 0 %} ({{ potential_parent.children|length }} под){%
                            endif %}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
                <p class="mt-1 text-sm text-gray-500">
                    {% if category.parent %}Сейчас под: {{ category.parent.name }}{% else %}Сейчас корневая категория{%
                    endif %}
                </p>
            </div>

            <div>
                <label for="sort_order" class="block text-sm font-medium text-gray-700">Порядок сортировки</label>
                <input type="number"
                       id="sort_order"
                       name="sort_order"
                       value="{{ category.sort_order or 0 }}"
                       min="0"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <p class="mt-1 text-sm text-gray-500">Меньшие числа отображаются первыми (0 = наивысший приоритет)</p>
            </div>
        </div>

        <!-- Статистика категории -->
        {% if category.children|length > 0 or category.products|length > 0 %}
        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h4 class="text-sm font-medium text-gray-900 mb-2">Статистика категории</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="text-gray-500">Товары:</span>
                    <span class="font-medium text-green-600">{{ category.products|length }}</span>
                </div>
                <div>
                    <span class="text-gray-500">Подкатегории:</span>
                    <span class="font-medium text-blue-600">{{ category.children|length }}</span>
                </div>
                {% if category.children|length > 0 %}
                <div class="col-span-2 md:col-span-1">
                    <span class="text-gray-500">Подкатегории:</span>
                    <div class="mt-1">
                        {% for child in category.children[:3] %}
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">{{ child.name }}</span>
                        {% endfor %}
                        {% if category.children|length > 3 %}
                        <span class="text-xs text-gray-500">+{{ category.children|length - 3 }} еще</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Настройки -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-6">Настройки</h3>

        <div class="flex items-center space-x-6">
            <div class="flex items-center">
                <input type="checkbox"
                       id="is_active"
                       name="is_active"
                       value="true"
                       {% if category.is_active %}checked{% endif %}
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="is_active" class="ml-2 block text-sm text-gray-900">Активна</label>
                <p class="ml-2 text-xs text-gray-500">Разрешить назначение товаров в эту категорию</p>
            </div>
        </div>

        {% if category.products|length > 0 and not category.is_active %}
        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Предупреждение:</strong> К этой категории привязано {{ category.products|length }}
                        товар(ов).
                        Деактивация может повлиять на видимость товаров.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Действия формы -->
    <div class="flex justify-end space-x-4">
        <a href="/admin/categories"
           class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md text-sm font-medium">
            Отмена
        </a>
        <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium">
            Обновить категорию
        </button>
    </div>
</form>

<script>

    document.getElementById('category-edit-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const jsonData = {};


        for (let [key, value] of formData.entries()) {

            if (['sort_order', 'parent_id'].includes(key) && value) {
                jsonData[key] = parseInt(value);
            } else if (['is_active'].includes(key)) {
                jsonData[key] = true;
            } else if (value) {
                jsonData[key] = value;
            }
        }


        if (!jsonData.is_active) jsonData.is_active = false;


        fetch('/api/categories/{{ category.id }}', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jsonData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {

                document.getElementById('form-response').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        <strong>Категория успешно обновлена!</strong>
                    </div>
                `;


                setTimeout(() => {
                    document.getElementById('form-response').innerHTML = '';
                }, 3000);
            } else {
                throw new Error('Обновление категории не удалось');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            document.getElementById('form-response').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <strong>Ошибка:</strong> Не удалось обновить категорию. Проверьте данные формы и попробуйте снова.
                </div>
            `;
        });
    });


    document.getElementById('parent_id').addEventListener('change', function() {
        const helpText = this.parentNode.querySelector('.text-gray-500');
        if (this.value) {
            helpText.textContent = 'Эта категория будет перемещена под выбранную родительскую категорию';
        } else {
            helpText.textContent = 'Эта категория станет корневой категорией';
        }
    });


    document.getElementById('parent_id').addEventListener('change', function() {
        if (this.value == '{{ category.id }}') {
            alert('Категория не может быть своим собственным родителем!');
            this.value = '{{ category.parent_id or "" }}';
        }
    });
</script>
{% endblock %}