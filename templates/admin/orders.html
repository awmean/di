{% extends 'base.html' %}

{% block title %}Orders - Admin{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block content %}
<div class="mb-8 flex justify-between items-center">
    <h2 class="text-2xl font-bold text-gray-900">Orders</h2>
    <div class="flex space-x-3">
        <div class="relative">
            <select id="status-filter"
                    class="bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
                    onchange="filterByStatus(this.value)">
                <option value="">All Statuses</option>
                <option value="new">New</option>
                <option value="processing">Processing</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <a href="/admin/orders/create"
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            Create Order
        </a>
    </div>
</div>

<!-- Orders Table -->
<div class="bg-white shadow-sm rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Order ID
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Customer
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Comment
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Items & Quantities
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Created
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Updated
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Actions
                </th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            {% for order in orders %}
            <tr id="order-row-{{ order.id }}" class="hover:bg-gray-50" data-status="{{ order.status }}">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                    #{{ order.id }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">{{ order.customer_name }}</div>
                    <div class="text-sm text-gray-500">{{ order.customer_phone }}</div>
                </td>
                <td class="px-6 py-4">
                    {% if order.comment %}
                    <div class="text-sm text-gray-700 max-w-xs">
                        {{ order.comment }}
                    </div>
                    {% else %}
                    <span class="text-gray-400 text-sm italic">No comment</span>
                    {% endif %}
                </td>
                <td class="px-6 py-4">
                    {% if order.items|length > 0 %}
                    <div class="text-sm text-gray-900">
                        {% for item in order.items %}
                        <div class="mb-1">
                            {{ item.quantity }}x {{ item.product.name if item.product else 'Product #' +
                            item.product_id|string }}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <span class="text-gray-400 text-sm italic">No items</span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if order.status == 'new' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        üÜï New
                    </span>
                    {% elif order.status == 'processing' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ‚è≥ Processing
                    </span>
                    {% elif order.status == 'completed' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ‚úÖ Completed
                    </span>
                    {% elif order.status == 'cancelled' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        ‚ùå Cancelled
                    </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div>{{ order.created_at.strftime('%Y-%m-%d') }}</div>
                    <div class="text-xs text-gray-400">{{ order.created_at.strftime('%H:%M') }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div>{{ order.updated_at.strftime('%Y-%m-%d') }}</div>
                    <div class="text-xs text-gray-400">{{ order.updated_at.strftime('%H:%M') }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <div class="flex items-center justify-end space-x-2">
                        <!-- Status Quick Actions -->
                        {% if order.status == 'new' %}
                        <button
                                hx-put="/api/orders/{{ order.id }}/status?status=processing"
                                hx-swap="none"
                                hx-on:htmx:after-request="if(event.detail.xhr.status === 200) { location.reload(); }"
                                class="text-blue-600 hover:text-blue-900 text-xs px-2 py-1 bg-blue-50 rounded"
                                title="Mark as Processing">
                            Process
                        </button>
                        {% elif order.status == 'processing' %}
                        <button
                                hx-put="/api/orders/{{ order.id }}/status?status=completed"
                                hx-swap="none"
                                hx-on:htmx:after-request="if(event.detail.xhr.status === 200) { location.reload(); }"
                                class="text-green-600 hover:text-green-900 text-xs px-2 py-1 bg-green-50 rounded"
                                title="Mark as Completed">
                            Complete
                        </button>
                        {% endif %}

                        {% if order.status in ['new', 'processing'] %}
                        <button
                                hx-put="/api/orders/{{ order.id }}/status?status=cancelled"
                                hx-confirm="Are you sure you want to cancel this order?"
                                hx-swap="none"
                                hx-on:htmx:after-request="if(event.detail.xhr.status === 200) { location.reload(); }"
                                class="text-red-600 hover:text-red-900 text-xs px-2 py-1 bg-red-50 rounded"
                                title="Cancel Order">
                            Cancel
                        </button>
                        {% endif %}

                        <button
                                hx-delete="/api/orders/{{ order.id }}"
                                hx-confirm="Are you sure you want to delete this order? This action cannot be undone."
                                hx-target="#order-row-{{ order.id }}"
                                hx-swap="delete"
                                class="text-red-600 hover:text-red-900 text-sm">
                            Delete
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not orders %}
    <div class="text-center py-8">
        <div class="text-gray-500 text-lg">No orders found</div>
        <p class="text-gray-400 mt-2">Orders will appear here when customers place them</p>
        <a href="/admin/orders/create"
           class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            Create Test Order
        </a>
    </div>
    {% endif %}
</div>

<!-- Summary Stats -->
{% if orders %}
<div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm font-medium text-gray-500">Total Orders</div>
        <div class="mt-2 text-3xl font-semibold text-gray-900">{{ orders|length }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm font-medium text-gray-500">New Orders</div>
        <div class="mt-2 text-3xl font-semibold text-yellow-600">
            {{ orders|selectattr('status', 'equalto', 'new')|list|length }}
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm font-medium text-gray-500">Processing</div>
        <div class="mt-2 text-3xl font-semibold text-blue-600">
            {{ orders|selectattr('status', 'equalto', 'processing')|list|length }}
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
        <div class="text-sm font-medium text-gray-500">Completed</div>
        <div class="mt-2 text-3xl font-semibold text-green-600">
            {{ orders|selectattr('status', 'equalto', 'completed')|list|length }}
        </div>
    </div>
</div>
{% endif %}

<script>
    // Filter orders by status
    function filterByStatus(status) {
        const rows = document.querySelectorAll('[data-status]');

        rows.forEach(row => {
            if (status === '' || row.getAttribute('data-status') === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Update URL parameter for bookmarking
        const url = new URL(window.location);
        if (status) {
            url.searchParams.set('status', status);
        } else {
            url.searchParams.delete('status');
        }
        window.history.replaceState({}, '', url);
    }

    // Set filter from URL parameter on page load
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const statusFilter = urlParams.get('status');
        if (statusFilter) {
            document.getElementById('status-filter').value = statusFilter;
            filterByStatus(statusFilter);
        }
    });

    // Handle status update responses
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.xhr.status === 200 && event.target.tagName === 'BUTTON') {
            // Success - show brief notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
            notification.innerHTML = '<strong>Success!</strong> Order status updated.';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    });

    // Auto-refresh orders every 30 seconds (optional)
    /*
    setInterval(function() {
        // Only refresh if not in middle of action
        if (!document.querySelector('.htmx-request')) {
            location.reload();
        }
    }, 30000);
    */
</script>
{% endblock %}